name: Deploy to Kolumn-deploy

# This workflow should be copied to the schemabounce/Kolumn-deploy repository
# It handles the actual deployment to the public Kolumn-deploy repository
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., 1.2.3)'
        required: true
        type: string
      tag:
        description: 'Git tag (e.g., v1.2.3)'
        required: true
        type: string
      source_repo:
        description: 'Source repository'
        required: true
        type: string
      run_id:
        description: 'Source workflow run ID'
        required: true
        type: string

env:
  DEPLOY_REPO: 'schemabounce/Kolumn-deploy'
  SOURCE_REPO_TOKEN: ${{ secrets.SOURCE_REPO_TOKEN }}
  DEPLOY_REPO_TOKEN: ${{ secrets.DEPLOY_REPO_TOKEN || secrets.SOURCE_REPO_TOKEN }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  deploy:
    name: Deploy Binaries
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    steps:
      - name: Download release packages from private repo
        run: |
          echo "ğŸ”½ Downloading release packages from ${{ inputs.source_repo }} run ${{ inputs.run_id }}"
          
          # Debug: Check token availability  
          if [ -z "$SOURCE_REPO_TOKEN" ]; then
            echo "âŒ SOURCE_REPO_TOKEN environment variable is empty"
            echo ""
            echo "ğŸ”§ To fix this issue:"
            echo "1. Create a Personal Access Token at https://github.com/settings/personal-access-tokens/new"
            echo "2. Grant 'actions:read' and 'contents:read' permissions for SchemaBounce/Kolumn"
            echo "3. Add the token as a repository secret named 'SOURCE_REPO_TOKEN'"
            echo "4. Go to: https://github.com/${{ env.DEPLOY_REPO }}/settings/secrets/actions"
            echo ""
            echo "ğŸ” Available environment variables:"
            env | grep -E "(TOKEN|GITHUB)" || echo "No token-related variables found"
            exit 1
          else
            echo "âœ… SOURCE_REPO_TOKEN is available (length: ${#SOURCE_REPO_TOKEN})"
          fi
          
          # Retry mechanism for artifact availability
          MAX_RETRIES=10
          RETRY_COUNT=0
          ARTIFACT_URL=""
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "ğŸ”„ Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES - Checking for artifacts..."
            
            # Get the artifact download URL using GitHub API
            ARTIFACT_RESPONSE=$(curl -s -L \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $SOURCE_REPO_TOKEN" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/${{ inputs.source_repo }}/actions/runs/${{ inputs.run_id }}/artifacts")
            
            # Check if we got a valid response
            if echo "$ARTIFACT_RESPONSE" | jq -e '.artifacts' > /dev/null 2>&1; then
              ARTIFACT_URL=$(echo "$ARTIFACT_RESPONSE" | jq -r '.artifacts[] | select(.name == "kolumn-release-packages") | .archive_download_url')
              
              if [ "$ARTIFACT_URL" != "null" ] && [ -n "$ARTIFACT_URL" ]; then
                echo "âœ… Found artifact URL: $ARTIFACT_URL"
                break
              else
                echo "â³ Artifact not ready yet. Available artifacts:"
                echo "$ARTIFACT_RESPONSE" | jq -r '.artifacts[].name' || echo "No artifacts found"
              fi
            else
              echo "âŒ API Error response:"
              echo "$ARTIFACT_RESPONSE"
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "â³ Waiting 30 seconds before retry..."
              sleep 30
            fi
          done
          
          if [ "$ARTIFACT_URL" = "null" ] || [ -z "$ARTIFACT_URL" ]; then
            echo "âŒ Error: Could not find kolumn-release-packages artifact after $MAX_RETRIES attempts"
            echo "ğŸ” Final artifacts check:"
            curl -H "Authorization: Bearer $SOURCE_REPO_TOKEN" \
              "https://api.github.com/repos/${{ inputs.source_repo }}/actions/runs/${{ inputs.run_id }}/artifacts"
            exit 1
          fi
          
          echo "ğŸ“¦ Artifact URL: $ARTIFACT_URL"
          
          # Download the artifact with retry
          echo "â¬‡ï¸ Downloading artifact..."
          MAX_DOWNLOAD_RETRIES=3
          DOWNLOAD_RETRY=0
          
          while [ $DOWNLOAD_RETRY -lt $MAX_DOWNLOAD_RETRIES ]; do
            if curl -L \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $SOURCE_REPO_TOKEN" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              -o release-packages.zip \
              "$ARTIFACT_URL"; then
              echo "âœ… Download successful!"
              break
            else
              DOWNLOAD_RETRY=$((DOWNLOAD_RETRY + 1))
              if [ $DOWNLOAD_RETRY -lt $MAX_DOWNLOAD_RETRIES ]; then
                echo "â³ Download failed, retrying in 10 seconds..."
                sleep 10
              fi
            fi
          done
          
          if [ $DOWNLOAD_RETRY -eq $MAX_DOWNLOAD_RETRIES ]; then
            echo "âŒ Failed to download artifact after $MAX_DOWNLOAD_RETRIES attempts"
            exit 1
          fi
          
          # Extract packages
          echo "ğŸ“‚ Extracting release packages..."
          unzip release-packages.zip
          ls -la
          
          # Show structure of extracted files
          echo "ğŸ“ Extracted file structure:"
          find . -name "kolumn-*" -type f | head -20

      - name: Setup deployment environment
        run: |
          git config --global user.name "Kolumn Release Bot"
          git config --global user.email "bot@kolumn.com"

      - name: Clone public deploy repository
        run: |
          echo "ğŸ“‚ Cloning ${{ env.DEPLOY_REPO }}"
          git clone https://$DEPLOY_REPO_TOKEN@github.com/${{ env.DEPLOY_REPO }}.git deploy
          cd deploy
          
          # Create directory structure
          mkdir -p releases/v${{ inputs.version }}
          mkdir -p binaries
          mkdir -p scripts

      - name: Deploy binaries to public repo
        run: |
          VERSION="${{ inputs.version }}"
          cd deploy
          
          echo "ğŸ“¦ Deploying Kolumn v${VERSION} binaries"
          
          # Check what files we have available
          echo "ğŸ” Available files in parent directory:"
          ls -la ../kolumn-* || echo "No kolumn-* files found"
          
          # Find all kolumn package files
          PACKAGE_FILES=$(find .. -name "kolumn-${VERSION}-*" -type f || echo "")
          
          if [ -z "$PACKAGE_FILES" ]; then
            echo "âŒ Error: No package files found for version ${VERSION}"
            echo "ğŸ” Looking for any kolumn files..."
            find .. -name "kolumn-*" -type f || echo "No kolumn files found at all"
            exit 1
          fi
          
          echo "ğŸ“ Found package files:"
          echo "$PACKAGE_FILES"
          
          # Copy release packages to versioned directory
          echo "$PACKAGE_FILES" | while read -r file; do
            if [ -f "$file" ]; then
              echo "ğŸ“‹ Copying: $file"
              cp "$file" "releases/v${VERSION}/"
            fi
          done
          
          # Also copy to latest directory for convenience
          mkdir -p releases/latest
          echo "$PACKAGE_FILES" | while read -r file; do
            if [ -f "$file" ]; then
              cp "$file" "releases/latest/"
            fi
          done
          
          # Verify files were copied
          echo "âœ… Files in releases/v${VERSION}/:"
          ls -la "releases/v${VERSION}/" || echo "Directory is empty"
          echo "âœ… Files in releases/latest/:"
          ls -la "releases/latest/" || echo "Directory is empty"
          
          # Update version metadata
          cat > releases/latest/version.json << EOF
          {
            "version": "${VERSION}",
            "tag": "${{ inputs.tag }}",
            "released": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "platforms": [
              "linux-amd64", "linux-arm64",
              "darwin-amd64", "darwin-arm64", 
              "windows-amd64", "windows-arm64"
            ]
          }
          EOF
          
          cp releases/latest/version.json releases/v${VERSION}/

      - name: Update install script
        run: |
          cd deploy
          
          # Create/update the install script
          cat > install.sh << 'EOF'
          #!/bin/bash
          set -e
          
          # Kolumn Installation Script
          # Usage: curl -fsSL https://schemabounce.github.io/Kolumn-deploy/install.sh | bash
          
          INSTALL_DIR="/usr/local/bin"
          REPO="schemabounce/Kolumn-deploy"
          BASE_URL="https://github.com/${REPO}/releases/latest/download"
          
          # Colors for output
          RED='\033[0;31m'
          GREEN='\033[0;32m'
          YELLOW='\033[1;33m'
          BLUE='\033[0;34m'
          NC='\033[0m' # No Color
          
          echo -e "${BLUE}ğŸš€ Installing Kolumn...${NC}"
          
          # Detect OS and architecture
          OS=$(uname -s | tr '[:upper:]' '[:lower:]')
          ARCH=$(uname -m)
          
          case $ARCH in
              x86_64) ARCH="amd64" ;;
              arm64|aarch64) ARCH="arm64" ;;
              *) echo -e "${RED}âŒ Unsupported architecture: $ARCH${NC}"; exit 1 ;;
          esac
          
          case $OS in
              linux) ;;
              darwin) ;;
              *) echo -e "${RED}âŒ Unsupported OS: $OS${NC}"; exit 1 ;;
          esac
          
          # Get latest version
          echo -e "${YELLOW}ğŸ“¡ Fetching latest version...${NC}"
          VERSION_INFO=$(curl -s "https://schemabounce.github.io/Kolumn-deploy/releases/latest/version.json")
          VERSION=$(echo "$VERSION_INFO" | grep -o '"version": "[^"]*' | cut -d'"' -f4)
          
          if [ -z "$VERSION" ]; then
              echo -e "${RED}âŒ Failed to get latest version${NC}"
              exit 1
          fi
          
          echo -e "${GREEN}ğŸ“¦ Latest version: $VERSION${NC}"
          
          # Download and install
          PACKAGE="kolumn-${VERSION}-${OS}-${ARCH}.tar.gz"
          DOWNLOAD_URL="${BASE_URL}/${PACKAGE}"
          
          echo -e "${YELLOW}â¬‡ï¸  Downloading ${PACKAGE}...${NC}"
          curl -fsSL "$DOWNLOAD_URL" -o "/tmp/${PACKAGE}"
          
          echo -e "${YELLOW}ğŸ“‚ Extracting to ${INSTALL_DIR}...${NC}"
          cd /tmp
          tar -xzf "${PACKAGE}"
          
          # Install binaries
          sudo mv "kolumn-${VERSION}-${OS}-${ARCH}/kolumn" "${INSTALL_DIR}/"
          sudo mv "kolumn-${VERSION}-${OS}-${ARCH}/kolumn-provider-kolumn" "${INSTALL_DIR}/"
          sudo chmod +x "${INSTALL_DIR}/kolumn" "${INSTALL_DIR}/kolumn-provider-kolumn"
          
          # Cleanup
          rm -rf "/tmp/kolumn-${VERSION}-${OS}-${ARCH}" "/tmp/${PACKAGE}"
          
          # Verify installation
          echo -e "${YELLOW}ğŸ§ª Verifying installation...${NC}"
          if "${INSTALL_DIR}/kolumn" version >/dev/null 2>&1; then
              echo -e "${GREEN}âœ… Kolumn ${VERSION} installed successfully!${NC}"
              echo -e "${BLUE}ğŸ¯ Try: kolumn --help${NC}"
          else
              echo -e "${RED}âŒ Installation verification failed${NC}"
              exit 1
          fi
          EOF
          
          chmod +x install.sh
          cp install.sh scripts/

      - name: Create GitHub release in public repo
        run: |
          cd deploy
          VERSION="${{ inputs.version }}"
          TAG="${{ inputs.tag }}"
          
          # Create release notes
          cat > release-notes.md << EOF
          # Kolumn ${VERSION}
          
          Infrastructure-as-code tool for the modern data stack with enterprise governance.
          
          ## ğŸš€ Installation
          
          ### Quick Install (Recommended)
          \`\`\`bash
          curl -fsSL https://schemabounce.github.io/Kolumn-deploy/install.sh | bash
          \`\`\`
          
          ### Manual Download
          Download the appropriate package for your platform:
          - Linux AMD64: [kolumn-${VERSION}-linux-amd64.tar.gz](https://github.com/schemabounce/Kolumn-deploy/releases/download/${TAG}/kolumn-${VERSION}-linux-amd64.tar.gz)
          - Linux ARM64: [kolumn-${VERSION}-linux-arm64.tar.gz](https://github.com/schemabounce/Kolumn-deploy/releases/download/${TAG}/kolumn-${VERSION}-linux-arm64.tar.gz)
          - macOS AMD64: [kolumn-${VERSION}-darwin-amd64.tar.gz](https://github.com/schemabounce/Kolumn-deploy/releases/download/${TAG}/kolumn-${VERSION}-darwin-amd64.tar.gz)
          - macOS ARM64: [kolumn-${VERSION}-darwin-arm64.tar.gz](https://github.com/schemabounce/Kolumn-deploy/releases/download/${TAG}/kolumn-${VERSION}-darwin-arm64.tar.gz)
          - Windows AMD64: [kolumn-${VERSION}-windows-amd64.zip](https://github.com/schemabounce/Kolumn-deploy/releases/download/${TAG}/kolumn-${VERSION}-windows-amd64.zip)
          - Windows ARM64: [kolumn-${VERSION}-windows-arm64.zip](https://github.com/schemabounce/Kolumn-deploy/releases/download/${TAG}/kolumn-${VERSION}-windows-arm64.zip)
          
          ## âœ¨ What's Included
          - **kolumn**: Main CLI binary
          - **kolumn-provider-kolumn**: Governance provider binary
          - Multi-platform support (Linux, macOS, Windows)
          - Both AMD64 and ARM64 architectures
          
          ## ğŸ¯ Getting Started
          \`\`\`bash
          # Verify installation
          kolumn version
          
          # Create a new project
          kolumn init
          
          # See available commands
          kolumn --help
          \`\`\`
          
          ## ğŸ”— Links
          - ğŸ“– [Documentation](https://schemabounce.github.io/Kolumn-deploy)
          - ğŸ’¬ [Support](https://github.com/schemabounce/Kolumn-deploy/issues)
          EOF

      - name: Commit and push to deploy repo
        run: |
          cd deploy
          
          # Stage all changes
          git add .
          
          # Commit if there are changes
          if [ -n "$(git status --porcelain)" ]; then
              git commit -m "ğŸš€ Deploy Kolumn ${{ inputs.version }}
          
          - Added binaries for all platforms (Linux, macOS, Windows)
          - Updated install script
          - Updated version metadata
          - Ready for GitHub release"
              
              git push origin main
              echo "âœ… Changes pushed to deploy repository"
          else
              echo "â„¹ï¸  No changes to commit"
          fi

      - name: Verify release files before GitHub release
        run: |
          echo "ğŸ” Verifying files for GitHub release..."
          cd deploy
          
          VERSION="${{ inputs.version }}"
          RELEASE_FILES="releases/v${VERSION}/kolumn-${VERSION}-*"
          
          echo "ğŸ“ Looking for files matching: $RELEASE_FILES"
          ls -la $RELEASE_FILES || echo "âŒ No files match the pattern"
          
          if ls $RELEASE_FILES 1> /dev/null 2>&1; then
            echo "âœ… Release files found!"
            ls -la $RELEASE_FILES
          else
            echo "âŒ Error: No release files found for GitHub release"
            echo "ğŸ” Available files in releases directory:"
            find releases -type f || echo "No files in releases directory"
            exit 1
          fi

      - name: Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ env.DEPLOY_REPO_TOKEN }}
          tag_name: ${{ inputs.tag }}
          name: "Kolumn ${{ inputs.version }}"
          body_path: deploy/release-notes.md
          files: |
            deploy/releases/v${{ inputs.version }}/kolumn-${{ inputs.version }}-*
          draft: false
          prerelease: ${{ contains(inputs.version, 'dev') }}
          fail_on_unmatched_files: false
          generate_release_notes: false

      - name: Deployment summary
        run: |
          echo "ğŸ‰ Successfully deployed Kolumn ${{ inputs.version }} to public repository!"
          echo "ğŸ“¦ Release: https://github.com/${{ env.DEPLOY_REPO }}/releases/tag/${{ inputs.tag }}"
          echo "ğŸ”— Install: curl -fsSL https://schemabounce.github.io/Kolumn-deploy/install.sh | bash"